<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurant Page</title>
    <link rel="icon" href="ì„±ë­ë¨¹3.png" type="image/png" />
    <link rel="stylesheet" href="review_register.css" />
    <!-- ê¸°ì¡´ CSS íŒŒì¼ì„ ë§í¬ -->
    <link rel="stylesheet" href="header_footer.css" />
    <!-- í—¤ë”ì™€ í‘¸í„° ìŠ¤íƒ€ì¼ -->
    <!-- Google Fonts -->
      <link
   href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
   rel="stylesheet"
 />
  </head>
  <body>
    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <!-- ê°€ê²Œ ëª©ë¡ ì„¹ì…˜-->

    <div id="container">
      <div
        id="login-message"
        style="display: none; text-align: center; margin-top: 20px"
      >
        <h1>ë¦¬ë·° ì‘ì„±</h1>
        <p>
          ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ê³  ì‹¶ë‹¤ë©´
          <a href="login.html" style="color: blue">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”!
        </p>
      </div>

      <div class="review_form_container">
        <h1>ë¦¬ë·° ì‘ì„±</h1>
        <input type="hidden" id="reviewer" name="reviewer" value="" />
        <form
          id="reviewForm"
          method="POST"
          action="/reviews/submit"
          enctype="multipart/form-data"
        >
          <input type="hidden" id="restaurant-id" name="restaurant_id" />
          <input type="text" id="storeName" name="restaurant_name" readonly />
          <label>ì´ ê°€ê²Œì— ëŒ€í•œ ìƒì„¸í•œ í‰ê°€ë¥¼ í•´ì£¼ì„¸ìš”.</label>

          <!-- ë§› í‰ì  -->
          <div class="rating-container">
          <label for="tasteRating" class="taste-label">ë§›</label>
          <div id="taste-rating" class="star-rating">
            <span data-value="1">â˜…</span>
            <span data-value="2">â˜…</span>
            <span data-value="3">â˜…</span>
            <span data-value="4">â˜…</span>
            <span data-value="5">â˜…</span>
          </div>
          </div>
          <input type="hidden" id="tasteRating" name="taste_rating" value="0" />

          <!-- ì ‘ê·¼ì„± í‰ì  -->
          <div class="rating-container">
          <label for="accessRating" class="access-label">ì ‘ê·¼ì„±</label>
          <div id="access-rating" class="star-rating">
            <span data-value="1">â˜…</span>
            <span data-value="2">â˜…</span>
            <span data-value="3">â˜…</span>
            <span data-value="4">â˜…</span>
            <span data-value="5">â˜…</span>
          </div>
          </div>
          <input
            type="hidden"
            id="accessRating"
            name="access_rating"
            value="0"
          />

          <!-- ì¬ë°©ë¬¸ ì˜ì‚¬ í‰ì  -->
          <div class="rating-container">
          <label for="revisitRating" class="revisit-label">ì¬ë°©ë¬¸ ì˜ì‚¬</label>
          <div id="revisit-rating" class="star-rating">
            <span data-value="1">â˜…</span>
            <span data-value="2">â˜…</span>
            <span data-value="3">â˜…</span>
            <span data-value="4">â˜…</span>
            <span data-value="5">â˜…</span>
          </div>
          </div>
          <input
            type="hidden"
            id="revisitRating"
            name="revisit_rating"
            value="0"
          />
          <div class="price-container">
            <label for="checkPrice">ê°€ê²©(1ì¸):</label>
            <div id="price-options">
              <label>
                <input type="radio" name="price" value="10000" /> 10,000ì› ì´í•˜
              </label>
              <label>
                <input type="radio" name="price" value="20000" /> 10,000ì› ~ 20,000ì› 
              </label>
              <label>
                <input type="radio" name="price" value="30000" /> 20,000ì› ì´ìƒ
              </label>
            </div>
            <input type="hidden" id="selectedPrice" name="selected_price" value="" />
          </div>
          
           <!-- í…ìŠ¤íŠ¸ ë¦¬ë·° -->
            <textarea
            id="reviewText"
            name="review_text"
            rows="4"
            placeholder="ìˆ˜ì •ì´ë“¤ì˜ ë‚´ëˆë‚´ì‚° ì†”ì§í•œ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”. ì–´ë–¤ ë©”ë‰´ë¥¼ ë“œì…¨ëŠ”ì§€ë„ ê¼­ ì ì–´ì£¼ì„¸ìš”. ìì„¸í•œ ë¦¬ë·°ëŠ” ì‚¬ë‘ì…ë‹ˆë‹¤!ğŸ€ (10ì ì´ìƒ)"
          ></textarea>

          <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
          <div id="image-preview-container"></div>

          <!-- ì´ë¯¸ì§€ ë“±ë¡ ë²„íŠ¼ -->
          <div class="custom-file-upload">
            <label for="reviewPhoto" class="custom-upload-button">
              <i class="fas fa-camera upload-icon"></i>
            </label>
            <input type="file" id="reviewPhoto" name="review_photo" hidden onchange="previewImages(event)" />
          </div>

          
          <!-- Font Awesome CDN -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

          
          <button type="submit" class="submit-button">ë“±ë¡ ì™„ë£Œ</button>
        </form>
      </div>
    </div>

    <script>
     
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const authResponse = await fetch("/auth/status");
          const authStatus = await authResponse.json();

          // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë©”ì‹œì§€ì™€ í¼ í‘œì‹œ
          if (authStatus.loggedIn) {
            // ë¡œê·¸ì¸ëœ ìƒíƒœ
            document.getElementById("login-message").style.display = "none";
            document.querySelector(".review_form_container").style.display =
              "block";
            document.getElementById("reviewer").value = authStatus.nickname; // ë‹‰ë„¤ì„ ì„¤ì •
          } else {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
            document.getElementById("login-message").style.display = "block";
            document.querySelector(".review_form_container").style.display =
              "none";
          }
        } catch (error) {
          console.error("ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œê·¸ì¸ ë©”ì‹œì§€ í‘œì‹œ
          document.getElementById("login-message").style.display = "block";
          document.querySelector(".review_form_container").style.display =
            "none";
        }
      });

       // ê°€ê²©(1ì¸) ë¼ë””ì˜¤ ë²„íŠ¼ ì„¤ì •
  const priceRadios = document.querySelectorAll('input[name="price"]');
  const selectedPriceInput = document.getElementById("selectedPrice");

  // ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒëœ ê°’ì„ hidden í•„ë“œì— ì €ì¥
  priceRadios.forEach((radio) => {
    radio.addEventListener("change", () => {
      selectedPriceInput.value = radio.value;
    });
  });

      
      // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¦¬ë·° ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í¼ì— ì„¤ì •
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get("storeName");
        const restaurantID = urlParams.get("id");

        if (storeName) document.getElementById("storeName").value = storeName;
        if (restaurantID)
          document.getElementById("restaurant-id").value = restaurantID;
      };

      // ë³„ì  ì„ íƒ í•¨ìˆ˜
      function setupStarRating(ratingId, inputId) {
        const stars = document.querySelectorAll(`#${ratingId} span`);
        const input = document.getElementById(inputId);

        stars.forEach((star) => {
          star.addEventListener("click", () => {
            const rating = star.getAttribute("data-value");
            input.value = rating;

            // ì„ íƒëœ ë³„ì ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
            stars.forEach((s) => {
              s.style.color =
                s.getAttribute("data-value") <= rating ? "gold" : "gray";
            });
          });
        });
      }

      // DOM ë¡œë“œ í›„ ë³„ì  ì„¤ì •
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get("storeName");
        const restaurantID = urlParams.get("id");

        if (storeName) document.getElementById("storeName").value = storeName;
        if (restaurantID)
          document.getElementById("restaurant-id").value = restaurantID;

        // ê° ë³„ì  ì˜ì—­ì— ëŒ€í•œ ì„¤ì • í˜¸ì¶œ
        setupStarRating("taste-rating", "tasteRating");
        setupStarRating("access-rating", "accessRating");
        setupStarRating("revisit-rating", "revisitRating");
      };

      document
        .getElementById("reviewForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€

          const selectedPrice = document.querySelector('input[name="price"]:checked');
          if (!selectedPrice) {
            alert("ê°€ê²©(1ì¸)ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return; // í¼ ì œì¶œ ì¤‘ë‹¨
          }
          

          // â­ ë³„ì  ì„ íƒ í™•ì¸ (ê°ê° ë§›, ì ‘ê·¼ì„±, ì¬ë°©ë¬¸ ì˜ì‚¬)
    const tasteRating = document.getElementById("tasteRating").value;
    const accessRating = document.getElementById("accessRating").value;
    const revisitRating = document.getElementById("revisitRating").value;

    if (tasteRating === "0" || accessRating === "0" || revisitRating === "0") {
        alert("ëª¨ë“  ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
        return; // í¼ ì œì¶œ ì¤‘ë‹¨
    }


          const formData = new FormData(this);
          const restaurantID = document.getElementById("restaurant-id").value;

          try {
            const response = await fetch("/reviews/submit", {
              method: "POST",
              body: formData,
            });

            if (response.ok) {
              // ì„œë²„ ìš”ì²­ ì„±ê³µ ì‹œ ê°€ê²Œ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
              window.location.href = `/store_details?id=${restaurantID}`;
            } else {
              const errorMessage = await response.text();
              alert(`ë¦¬ë·° ì €ì¥ ì‹¤íŒ¨: ${errorMessage}`);
            }
          } catch (error) {
            console.error("ë¦¬ë·° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ë¦¬ë·° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
          }
        });

        function previewImages(event) {
  const imagePreviewContainer = document.getElementById("image-preview-container");
  const fileInput = event.target;
  const files = fileInput.files;

  // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
  imagePreviewContainer.innerHTML = "";

  if (files.length > 0) {
    Array.from(files).forEach((file) => {
      const reader = new FileReader();

      reader.onload = function(e) {
        const img = document.createElement("img");
        img.className = "review-image";
        img.src = e.target.result;
        imagePreviewContainer.appendChild(img);
      };

      reader.readAsDataURL(file);
    });

    
}
        }

    </script>
    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <script src="header_footer.js"></script>

    <!-- ë°˜ì‘í˜• -->
  </body>
</html>

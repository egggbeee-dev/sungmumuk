<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
     <link rel="icon" href="ì„±ë­ë¨¹3.png" type="image/png" />
    <title>My Inquiries</title>
    <link rel="stylesheet" href="my_inquiry.css" />
    <!-- ìŠ¤íƒ€ì¼ íŒŒì¼ -->
    <link rel="stylesheet" href="header_footer.css" />
     <!-- ìŠ¤íƒ€ì¼ -->
     <link
     href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
     rel="stylesheet"
   />
  </head>
  <body>
    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- ì œëª© ì„¹ì…˜ -->
    <div class="page-header">ë‚˜ì˜ ë¬¸ì˜ ë‚´ì—­</div>

    <div
      id="login-message"
      style="display: none; text-align: center; margin-top: 20px"
    >
      <p>
        ë‚˜ì˜ ë¬¸ì˜ ë‚´ì—­ì„ ë³´ê³ ì‹¶ë‹¤ë©´
        <a href="login.html" style="color: blue">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”!
      </p>
    </div>
    <!-- Main Inquiry Content -->
    <div class="inquiry-container"></div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Load Header, Footer, and Inquiry Data -->
    <script src="header_footer.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const authResponse = await fetch('/auth/status');
                const authStatus = await authResponse.json();
                console.log("ì¸ì¦ ìƒíƒœ í™•ì¸:", authStatus); // ğŸ” í™•ì¸ ë¡œê·¸ ì¶”ê°€
        
                if (!authStatus.loggedIn) {
                    document.getElementById('login-message').style.display = 'block';
                    return;
                }
        
                const response = await fetch('/my-inquiry');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
        
                const data = await response.json();
                const container = document.querySelector('.inquiry-container');
        
                if (data.length === 0) {
                    container.innerHTML = `<p class="no-inquiries">í˜„ì¬ ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }
        
                container.innerHTML = data.map(inquiry => `
                    <div class="inquiry-item" data-inquiry-id="${inquiry.inquiry_id}">
                        <div class="inquiry-header">
                            <h2 class="inquiry-title">${inquiry.title}</h2>
                            <span class="inquiry-status ${inquiry.status === 'ë‹µë³€ ì™„ë£Œ' ? 'ë‹µë³€ì™„ë£Œ' : 'ë‹µë³€ëŒ€ê¸°'}">
                                ${inquiry.status}
                            </span>
                        </div>
                        <div class="inquiry-details">
                            <p>ë¬¸ì˜ì¼: <span class="inquiry-date">${formatDate(inquiry.created_at)}</span></p>
                            <p class="inquiry-response-date">ë‹µë³€ì¼: 
                                <span class="response-date">${inquiry.answered_at ? formatDate(inquiry.answered_at) : 'ë‹µë³€ ëŒ€ê¸° ì¤‘'}</span>
                            </p>
                        </div>
                        <div class="inquiry-response">
                            <p><strong>ë¬¸ì˜ ë‚´ìš©:</strong></p>
                            <p>${inquiry.content}</p>
                        </div>
                        ${inquiry.answer && inquiry.answer.trim() ? `
                            <div class="admin-response">
                                <p><strong>ê´€ë¦¬ì ë‹µë³€:</strong></p>
                                <p>${inquiry.answer}</p>
                            </div>
                        ` : ''}
                        <div class="admin-reply" style="display: none;">
                            <textarea class="reply-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            <button class="submit-reply">ë‹µë³€ ë“±ë¡</button>
                        </div>
                    </div>
                `).join('');
        
                // âœ… ê´€ë¦¬ì ê³„ì •ì¼ ê²½ìš°ë§Œ ë‹µë³€ ì…ë ¥ë€ í‘œì‹œ
                if (authStatus.user.isAdmin === 1) { // ğŸ” authStatus.user.isAdmin â†’ authStatus.isAdminìœ¼ë¡œ ë³€ê²½
                    document.querySelectorAll('.admin-reply').forEach(replyBox => {
                        replyBox.style.display = "block";
                    });
        
                    document.querySelectorAll('.submit-reply').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            const inquiryItem = event.target.closest('.inquiry-item');
                            const inquiryId = inquiryItem.getAttribute('data-inquiry-id');
                            const replyText = inquiryItem.querySelector('.reply-input').value.trim();
        
                            if (!replyText) {
                                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
        
                            console.log(`ğŸ” ë¬¸ì˜ ID: ${inquiryId}, ë‹µë³€ ë‚´ìš©: "${replyText}"`); // ğŸ›  ë””ë²„ê¹…ìš© ë¡œê·¸
        
                            try {
                                const replyResponse = await fetch(`/my-inquiry/admin/reply/${inquiryId}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ answer: replyText })
                                });
        
                                const result = await replyResponse.json();
                                console.log("âœ… ì„œë²„ ì‘ë‹µ:", result); // ğŸ›  ì„œë²„ ì‘ë‹µ í™•ì¸
        
                                if (!replyResponse.ok) {
                                    throw new Error('ë‹µë³€ ë“±ë¡ ì‹¤íŒ¨');
                                }
        
                                alert('ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                location.reload();
                            } catch (error) {
                                console.error('ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                                alert('ë‹µë³€ ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                    });
                }
        
            } catch (error) {
                console.error('Error loading inquiries:', error);
                document.querySelector('.inquiry-container').innerHTML =
                    `<p class="error-message">ë¬¸ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            }
        });
        
        function formatDate(dateString) {
            if (!dateString) return ''; // ë‚ ì§œê°€ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
        
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                timeZone: 'Asia/Seoul' // í•œêµ­ ì‹œê°„ ì ìš©
            };
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', options);
        }
        
        </script>
        

    <!-- ë°˜ì‘í˜• -->
  </body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community</title>
    <link rel="icon" href="sungmumuk3.png" type="image/png" />
    <link rel="stylesheet" href="community_sub.css" />
    <!-- ìŠ¤íƒ€ì¼ ì‹œíŠ¸ ë§í¬ -->
    <link rel="stylesheet" href="header_footer.css" />
    <!-- í—¤ë” ë° í‘¸í„° ìŠ¤íƒ€ì¼ -->
    <script src="header_footer.js" defer></script>
    <!-- ìŠ¤íƒ€ì¼ -->
    <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />
  </head>
  <body>
    <div id="header-placeholder"></div>
    <!-- ì œëª© ì„¹ì…˜ -->
    <div class="page-header"> ììœ  ê²Œì‹œíŒ</div>

    <!-- Main Content -->
    <div
      id="login-message"
      style="display: none; text-align: center; margin-top: 20px"
    >
    </div>

    <div class="search-bar-container">
      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="ê¶ê¸ˆí•œ ë‚´ìš©ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!"
        />
        <button id="search-btn">ğŸ”</button>
      </div>
        <ul class="filter-box">
      <li>
          <select id="post-category">
              <option value="">ìµœì‹ ìˆœ</option>
              <option value="low">ì˜¤ë˜ëœ ìˆœ</option>
              <option value="mid">ì¢‹ì•„ìš” ë§ì€ ìˆœ</option>
   
          </select>
      </li> 
</ul>
      <div class="new-banner" onclick="location.href='free_new.html'">
        ìƒˆ ê¸€ ì‘ì„±
      </div>
    </div><div id="post-list">
      <!-- ê²Œì‹œë¬¼ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
    </div>

    <!-- ì‚¬ì´íŠ¸ ì•ˆë‚´ ë©”ì‹œì§€ -->
<div id="site-message">
  <button id="close-message">X</button>
  <p>í™˜ì˜í•©ë‹ˆë‹¤â¤ï¸ <br>ììœ ë¡­ê²Œ ì˜ê²¬ì„ ë‚˜ëˆ„ê³ , ì„œë¡œ ì†Œí†µí•´ë³´ì„¸ìš”!</p>

  <button id="hide-today">ì˜¤ëŠ˜ì€ ë” ì´ìƒ ë³´ì§€ ì•Šê¸°</button>
</div>


     <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <script>  
      document.addEventListener("DOMContentLoaded", function () {
        const messageBox = document.getElementById("site-message");
        const closeBtn = document.getElementById("close-message");
        const hideTodayBtn = document.getElementById("hide-today");
    
        // localStorageì—ì„œ 'hideMessage' ê°’ í™•ì¸ (ê°’ì´ ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°)
        if (localStorage.getItem("hideMessage") === "true") {
          messageBox.style.display = "none";
        }
    
        // X ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì‹œì§€ ì°½ ë‹«ê¸° (ì´ë²ˆë§Œ ë‹«í˜)
        closeBtn.addEventListener("click", function () {
          messageBox.style.display = "none";
        });
    
        // "ì˜¤ëŠ˜ì€ ë” ì´ìƒ ë³´ì§€ ì•Šê¸°" í´ë¦­ ì‹œ í•˜ë£¨ ë™ì•ˆ ìˆ¨ê¸°ê¸°
        hideTodayBtn.addEventListener("click", function () {
          localStorage.setItem("hideMessage", "true"); // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ìˆ¨ê¹€ ì„¤ì • ì €ì¥
          messageBox.style.display = "none"; // ë©”ì‹œì§€ ìˆ¨ê¹€
        });
      });

  document.addEventListener("DOMContentLoaded", async function () {
    const postList = document.getElementById("post-list");
    const searchInput = document.getElementById("search-input");
    const searchBtn = document.getElementById("search-btn");
    const filterSelect = document.getElementById("post-category");
    const loginMessage = document.getElementById("login-message");

    let currentUserId = null;  // ë¡œê·¸ì¸ ì‚¬ìš©ì ID ì €ì¥
    let posts = [];  // ê²Œì‹œê¸€ ì €ì¥ìš©

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    await checkAuthStatus();

    // ê²Œì‹œê¸€ ë¡œë“œ (ê¸°ë³¸ ìµœì‹ ìˆœ)
    await loadPosts();

    // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
    filterSelect.addEventListener('change', async function () {
        await loadPosts(this.value);
    });

    // ê²€ìƒ‰ ë²„íŠ¼ ë° ì—”í„° ê²€ìƒ‰
    searchBtn.addEventListener("click", searchPosts);
    searchInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") searchPosts();
    });

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    async function checkAuthStatus() {
        try {
            const res = await fetch("/auth/status");
            const data = await res.json();

            if (data.loggedIn) {
                currentUserId = data.user.id;
                loginMessage.style.display = "none";
            } else {
                currentUserId = null;
                loginMessage.style.display = "block";
            }
        } catch (err) {
            console.error("ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", err);
        }
    }

    // ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (í•„í„° ì ìš©)
    async function loadPosts(filter = "") {
        try {
            const res = await fetch(`/free/posts?filter=${filter}`);
            const data = await res.json();

            posts = data.map(post => ({
                post_id: post.post_id,
                title: post.title,
                content: post.content,
                image_url: post.image_url || '',
                category: post.category || '[ì¹´í…Œê³ ë¦¬]',
                user_id: post.user_id,
                like_count: post.like_count || 0
            }));

            renderPosts(posts);
        } catch (err) {
            console.error("ê²Œì‹œë¬¼ ë¡œë“œ ì˜¤ë¥˜:", err);
            alert("ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ê²Œì‹œê¸€ ë Œë”ë§
    function renderPosts(posts) {
        postList.innerHTML = "";

        if (posts.length === 0) {
            postList.innerHTML = "<p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        posts.forEach(post => {
            const postDiv = document.createElement("div");
            postDiv.classList.add("post");

            const titleLink = document.createElement("a");
            titleLink.href = `/free_post.html?id=${post.post_id}`;
            titleLink.innerHTML = `
                <span style="color: #8a63d2; font-weight: bold;">${post.category}</span>
                <span style="color: black; font-weight: bold;">${post.title}</span>`;
            titleLink.style.textDecoration = "none";

            postDiv.appendChild(titleLink);

            const contentDiv = document.createElement("div");
            contentDiv.textContent = post.content.slice(0, 100) + "...";
            postDiv.appendChild(contentDiv);

            const likeDiv = document.createElement("div");
            likeDiv.style.marginTop = "5px";
            likeDiv.style.fontSize = "14px";
            likeDiv.style.color = "#555";
            likeDiv.innerHTML = `â¤ï¸ ${post.like_count}`;
            postDiv.appendChild(likeDiv);

            postList.appendChild(postDiv);
        });
    }

        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ë Œë”ë§
        function renderPagination(totalPosts) {
          pagination.innerHTML = ""; // ê¸°ì¡´ í˜ì´ì§€ ë²„íŠ¼ë“¤ ì‚­ì œ
          const totalPages = Math.ceil(totalPosts / postsPerPage);

          // 'ë§¨ ì²˜ìŒ í˜ì´ì§€ë¡œ ì´ë™' ë²„íŠ¼
          const firstPageBtn = document.createElement("button");
          firstPageBtn.textContent = "<<";
          firstPageBtn.addEventListener("click", function () {
            currentPage = 1;
            loadPosts(currentPage);
          });
          pagination.appendChild(firstPageBtn);

          // 'ì´ì „ í˜ì´ì§€' ë²„íŠ¼
          const prevPageBtn = document.createElement("button");
          prevPageBtn.textContent = "<";
          prevPageBtn.addEventListener("click", function () {
            if (currentPage > 1) {
              currentPage--;
              loadPosts(currentPage);
            }
          });
          pagination.appendChild(prevPageBtn);

          // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤ (10í˜ì´ì§€ì”© ë³´ì´ê²Œ ìˆ˜ì •)
          const startPage = Math.floor((currentPage - 1) / 10) * 10 + 1; // ì‹œì‘ í˜ì´ì§€ ë²ˆí˜¸
          const endPage = Math.min(startPage + 9, totalPages); // ë í˜ì´ì§€ ë²ˆí˜¸ (ìµœëŒ€ 10í˜ì´ì§€)

          for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = i;

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì •

            prevPageBtn.style.margin = "0 3px";
            pageBtn.style.width = "40px"; // ë²„íŠ¼ í¬ê¸° ê³ ì •
            pageBtn.style.margin = "0 5px"; // ë²„íŠ¼ ê°„ ì—¬ë°± ì¶”ê°€
            pageBtn.style.display = "flex"; // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš©
            pageBtn.style.alignItems = "center"; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
            pageBtn.style.justifyContent = "center"; // ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬
            pageBtn.style.padding = "5px 10px"; // íŒ¨ë”© ì¶”ê°€
            pageBtn.style.fontSize = "16px"; // ê¸€ì í¬ê¸° ì„¤ì •

            // í˜„ì¬ í˜ì´ì§€ëŠ” ìƒ‰ìƒ ë³€ê²½
            if (i === currentPage) {
              pageBtn.style.backgroundColor = "#8E89F6"; // ì§„í•œ ìƒ‰ìƒ
              pageBtn.style.color = "#fff"; // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
              pageBtn.style.fontWeight = "bold"; // ê¸€ì ë‘ê»ê²Œ
            }

            pageBtn.addEventListener("click", function () {
              currentPage = i;
              loadPosts(currentPage);
            });
            pagination.appendChild(pageBtn);
          }

          // 'ë‹¤ìŒ í˜ì´ì§€' ë²„íŠ¼
          const nextPageBtn = document.createElement("button");
          nextPageBtn.textContent = ">";
          nextPageBtn.addEventListener("click", function () {
            if (currentPage < totalPages) {
              currentPage++;
              loadPosts(currentPage);
            }
          });
          pagination.appendChild(nextPageBtn);

          // 'ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™' ë²„íŠ¼
          const lastPageBtn = document.createElement("button");
          lastPageBtn.textContent = ">>";
          lastPageBtn.addEventListener("click", function () {
            currentPage = totalPages;
            loadPosts(currentPage);
          });
          pagination.appendChild(lastPageBtn);

          // í˜ì´ì§€ë„¤ì´ì…˜ ë°” ìŠ¤íƒ€ì¼ì„ ê°€ë¡œë¡œ ì„¤ì •
          pagination.style.display = "flex";
          pagination.style.justifyContent = "center"; // ë²„íŠ¼ë“¤ì„ ê°€ë¡œë¡œ ì¤‘ì•™ ì •ë ¬
          pagination.style.alignItems = "center"; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
          lastPageBtn.style.margin = "0 3px";
        }

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        searchBtn.addEventListener("click", async function () {
          const query = searchInput.value.trim();
          if (!query) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          try {
            const response = await fetch(
              `/free/search?query=${encodeURIComponent(query)}`
            );
            if (response.ok) {
              const posts = await response.json();
              renderPosts(posts);
            } else {
              alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("ê²€ìƒ‰ ìš”ì²­ ì˜¤ë¥˜:", error);
          }
        });

        checkAuthStatus(); // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        loadPosts();
      });
    </script>
    

      <div class="footer-info">
        <!-- ì¶”ê°€ì ì¸ ì •ë³´ -->
      </div>
    </footer>

    <!-- ë°˜ì‘í˜• -->
  </body>
</html>

    

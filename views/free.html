<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community</title>
    <link rel="icon" href="ì„±ë­ë¨¹3.png" type="image/png" />
    <link rel="stylesheet" href="community_sub.css" />
    <!-- ìŠ¤íƒ€ì¼ ì‹œíŠ¸ ë§í¬ -->
    <link rel="stylesheet" href="header_footer.css" />
    <!-- í—¤ë” ë° í‘¸í„° ìŠ¤íƒ€ì¼ -->
    <script src="header_footer.js" defer></script>
    <!-- í—¤ë” ë° í‘¸í„° ë™ì  ë¡œë“œ -->
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Nanum+Gothic&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div
      id="login-message"
      style="display: none; text-align: center; margin-top: 20px"
    >
      <p>
        ì»¤ë®¤ë‹ˆí‹°ë¥¼ ë³´ë ¤ë©´
        <a href="login.html" style="color: blue">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”!
      </p>
    </div>

    <div class="search-bar-container">
      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="ê¶ê¸ˆí•œ ë‚´ìš©ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!"
        />
        <button id="search-btn">ğŸ”</button>
      </div>
      <form action="free_new.html" method="get" class="new-post-form">
        <button id="new-post-btn" type="submit">ìƒˆ ê¸€ ì‘ì„±</button>
      </form>
    </div>

    <div id="post-list">
      <!-- ê²Œì‹œë¬¼ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const postList = document.getElementById("post-list");
        const loginMessage = document.getElementById("login-message");
        const searchBar = document.querySelector(".search-bar-container");
        const searchInput = document.getElementById("search-input");
        const searchBtn = document.getElementById("search-btn");
        const newPostBtn = document.getElementById("new-post-btn");

        let currentUserId = null;
    
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        async function checkAuthStatus() {
          try {
            const response = await fetch("/auth/status");
            const authStatus = await response.json();

            if (!authStatus.loggedIn) {
              loginMessage.style.display = "block";
              postList.style.display = "none";
              newPostBtn.style.display = "none";
              searchBar.style.display = "none";
            } else {
              loginMessage.style.display = "none";
              postList.style.display = "block";
              newPostBtn.style.display = "inline-block";
              searchBar.style.display = "flex";
              currentUserId = authStatus.userId; // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID ì €ì¥
              loadPosts();
            }
          } catch (error) {
            console.error("ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
          }
        }

        //ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPosts() {
          try {
            const response = await fetch("/free/posts");
            const posts = await response.json();
            renderPosts(posts);
          } catch (error) {
            console.error("ê²Œì‹œë¬¼ ë¡œë“œ ì˜¤ë¥˜:", error);
          }
        }

        // ê²Œì‹œê¸€ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
        function renderPosts(posts) {
          postList.innerHTML = "";
          if (posts.length === 0) {
            postList.innerHTML = "<p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }
          posts.forEach((post) => {
            const postDiv = document.createElement("div");
            postDiv.classList.add("post");

            const titleLink = document.createElement("a");
            titleLink.href = `/free_post.html?id=${post.post_id}`;
            titleLink.textContent = `${post.category} ${post.title}`;
            titleLink.style.color = "blue";
            titleLink.style.textDecoration = "none";
            postDiv.appendChild(titleLink);

            const contentDiv = document.createElement("div");
            contentDiv.textContent = post.content.slice(0, 100) + "...";
            postDiv.appendChild(contentDiv);

            // ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            if (currentUserId === post.user_id) {
              const editBtn = document.createElement("button");
              editBtn.textContent = "ìˆ˜ì •";
              editBtn.addEventListener("click", () => editPost(post));
              postDiv.appendChild(editBtn);

              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "ì‚­ì œ";
              deleteBtn.style.backgroundColor = "red";
              deleteBtn.style.color = "white";
              deleteBtn.addEventListener("click", () =>
                deletePost(post.post_id)
              );
              postDiv.appendChild(deleteBtn);
            }

            postList.appendChild(postDiv);
          });
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ë Œë”ë§
        function renderPagination(totalPosts) {
          pagination.innerHTML = ""; // ê¸°ì¡´ í˜ì´ì§€ ë²„íŠ¼ë“¤ ì‚­ì œ
          const totalPages = Math.ceil(totalPosts / postsPerPage);

          // 'ë§¨ ì²˜ìŒ í˜ì´ì§€ë¡œ ì´ë™' ë²„íŠ¼
          const firstPageBtn = document.createElement("button");
          firstPageBtn.textContent = "<<";
          firstPageBtn.addEventListener("click", function () {
            currentPage = 1;
            loadPosts(currentPage);
          });
          pagination.appendChild(firstPageBtn);

          // 'ì´ì „ í˜ì´ì§€' ë²„íŠ¼
          const prevPageBtn = document.createElement("button");
          prevPageBtn.textContent = "<";
          prevPageBtn.addEventListener("click", function () {
            if (currentPage > 1) {
              currentPage--;
              loadPosts(currentPage);
            }
          });
          pagination.appendChild(prevPageBtn);

          // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤ (10í˜ì´ì§€ì”© ë³´ì´ê²Œ ìˆ˜ì •)
          const startPage = Math.floor((currentPage - 1) / 10) * 10 + 1; // ì‹œì‘ í˜ì´ì§€ ë²ˆí˜¸
          const endPage = Math.min(startPage + 9, totalPages); // ë í˜ì´ì§€ ë²ˆí˜¸ (ìµœëŒ€ 10í˜ì´ì§€)

          for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = i;

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì •

            prevPageBtn.style.margin = "0 3px";
            pageBtn.style.width = "40px"; // ë²„íŠ¼ í¬ê¸° ê³ ì •
            pageBtn.style.margin = "0 5px"; // ë²„íŠ¼ ê°„ ì—¬ë°± ì¶”ê°€
            pageBtn.style.display = "flex"; // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš©
            pageBtn.style.alignItems = "center"; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
            pageBtn.style.justifyContent = "center"; // ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬
            pageBtn.style.padding = "5px 10px"; // íŒ¨ë”© ì¶”ê°€
            pageBtn.style.fontSize = "16px"; // ê¸€ì í¬ê¸° ì„¤ì •

            // í˜„ì¬ í˜ì´ì§€ëŠ” ìƒ‰ìƒ ë³€ê²½
            if (i === currentPage) {
              pageBtn.style.backgroundColor = "#8E89F6"; // ì§„í•œ ìƒ‰ìƒ
              pageBtn.style.color = "#fff"; // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
              pageBtn.style.fontWeight = "bold"; // ê¸€ì ë‘ê»ê²Œ
            }

            pageBtn.addEventListener("click", function () {
              currentPage = i;
              loadPosts(currentPage);
            });
            pagination.appendChild(pageBtn);
          }

          // 'ë‹¤ìŒ í˜ì´ì§€' ë²„íŠ¼
          const nextPageBtn = document.createElement("button");
          nextPageBtn.textContent = ">";
          nextPageBtn.addEventListener("click", function () {
            if (currentPage < totalPages) {
              currentPage++;
              loadPosts(currentPage);
            }
          });
          pagination.appendChild(nextPageBtn);

          // 'ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™' ë²„íŠ¼
          const lastPageBtn = document.createElement("button");
          lastPageBtn.textContent = ">>";
          lastPageBtn.addEventListener("click", function () {
            currentPage = totalPages;
            loadPosts(currentPage);
          });
          pagination.appendChild(lastPageBtn);

          // í˜ì´ì§€ë„¤ì´ì…˜ ë°” ìŠ¤íƒ€ì¼ì„ ê°€ë¡œë¡œ ì„¤ì •
          pagination.style.display = "flex";
          pagination.style.justifyContent = "center"; // ë²„íŠ¼ë“¤ì„ ê°€ë¡œë¡œ ì¤‘ì•™ ì •ë ¬
          pagination.style.alignItems = "center"; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
          lastPageBtn.style.margin = "0 3px";
        }
        // ê²Œì‹œê¸€ ìˆ˜ì •
        async function editPost(post) {
          const newContent = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:", post.content);
          if (!newContent) return;

          try {
            const response = await fetch(`/free/posts/${post.post_id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ content: newContent }),
            });
            if (response.ok) {
              alert("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              loadPosts();
            } else {
              alert("ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("ê²Œì‹œê¸€ ìˆ˜ì • ì˜¤ë¥˜:", error);
          }
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deletePost(postId) {
          const confirmDelete = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
          if (!confirmDelete) return;

          try {
            const response = await fetch(`/free/posts/${postId}`, {
              method: "DELETE",
            });
            if (response.ok) {
              alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              loadPosts();
            } else {
              alert("ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:", error);
          }
        }

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        searchBtn.addEventListener("click", async function () {
          const query = searchInput.value.trim();
          if (!query) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          try {
            const response = await fetch(
              `/free/search?query=${encodeURIComponent(query)}`
            );
            if (response.ok) {
              const posts = await response.json();
              renderPosts(posts);
            } else {
              alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("ê²€ìƒ‰ ìš”ì²­ ì˜¤ë¥˜:", error);
          }
        });

        //checkAuthStatus(); // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        loadPosts();
      });
    </script>
    

    <footer class="footer">
      <div class="footer-logo">
        <img src="ì„±ë­ë¨¹2.png" alt="Logo" class="footer-logo-img" />
      </div>
      <div class="footer-info">
        <!-- ì¶”ê°€ì ì¸ ì •ë³´ -->
      </div>
    </footer>

    <!-- ë°˜ì‘í˜• -->
  </body>
</html>

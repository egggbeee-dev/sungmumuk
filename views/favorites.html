<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°œí•œ ê°€ê²Œ ì „ì²´ ë³´ê¸°</title>
    <link rel="icon" href="ì„±ë­ë¨¹3.png" type="image/png">
    <link rel="stylesheet" href="favorites.css"> <!-- í˜ì´ì§€ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="header_footer.css"> <!-- í—¤ë”ì™€ í‘¸í„° ìŠ¤íƒ€ì¼ -->
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
 <!-- ë©”ì¸ ì»¨í…ì¸  -->
</div>
<div class="container">
        <h1>ì°œí•œ ê°€ê²Œ</h1>
    </header>

    <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
    <div class="search-section">
        <input type="text" id="search-input" placeholder="ê°€ê²Œëª… ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰" onkeypress="handleKeyPress(event)">
        <button id="search-button" onclick="searchStores()">ğŸ”</button>
    </div>

    <!-- ê°€ê²Œ ëª©ë¡ ì„¹ì…˜-->
    <div id="login-message" style="display: none; text-align: center; margin-top: 20px;">
        <p>ì°œí•œ ê°€ê²Œë¥¼ ë³´ë ¤ë©´ <a href="login.html" style="color: blue;">ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”!</p>
    </div>
    <div id="favorites-container" style="display: none;"></div>

    <!-- í•˜ë‹¨ ë²„íŠ¼ ì„¹ì…˜ -->
    <div class="action-buttons">
        <button onclick="removeFromFavorites()">ì°œì—ì„œ ì‚­ì œí•˜ê¸°</button>
        <button onclick="goToCompare()">ë¹„êµí•¨ìœ¼ë¡œ ê°€ê¸°</button>
    </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script>

// DOMContentLoaded ì´ë²¤íŠ¸
document.addEventListener('DOMContentLoaded', function () {
    // ë”ë¯¸ ë°ì´í„° ë Œë”ë§
    renderFavorites(mockFavorites);
});
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
   document.addEventListener('DOMContentLoaded', async function () {
        try {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const authResponse = await fetch('/auth/status');
            const authStatus = await authResponse.json();
    
            if (!authStatus.loggedIn) {
                // ë¹„ë¡œê·¸ì¸ ìƒíƒœ ì²˜ë¦¬
                console.log("ì¸ì¦ ìƒíƒœ í™•ì¸: ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì…ë‹ˆë‹¤.");
                document.getElementById('login-message').style.display = 'block';
                document.querySelectorAll('.action-buttons').forEach(button => {
                    button.style.display = 'none';
                });
                
            } else {
                // ë¡œê·¸ì¸ëœ ìƒíƒœ
                console.log("ì¸ì¦ ìƒíƒœ í™•ì¸: ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    
                // /favorites API í˜¸ì¶œ
                try {
                    const response = await fetch('/favorites'); // API í˜¸ì¶œ
                    if (response.ok) {
                        const data = await response.json(); // ì‘ë‹µ ë°ì´í„° íŒŒì‹±
                        console.log('API ì‘ë‹µ ë°ì´í„°:', data);
    
                        if (data && data.rows && Array.isArray(data.rows)) {
                            const stores = data.rows; // rowsë¥¼ stores ë³€ìˆ˜ì— í• ë‹¹
    
                            if (stores.length > 0) {
                                console.log('ê°€ê²Œ ë°ì´í„°:', stores);
                                renderFavorites(stores); // ê°€ê²Œ ë°ì´í„° ë Œë”ë§
                            } else {
                                console.error('ê°€ê²Œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                                document.getElementById('favorites-container').innerHTML = "<p>ì°œí•œ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                            }
                        }
                    } else {
                        console.error('ì°œí•œ ê°€ê²Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                    }
                } catch (error) {
                    console.error('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                }
            }
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    });
    /**
     * ì°œí•œ ê°€ê²Œ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
     * @param {Array} stores - ê°€ê²Œ ë°ì´í„° ë°°ì—´
     */
     function renderFavorites(stores) {
        const container = document.getElementById('favorites-container');
        container.style.display = 'block'; // ì»¨í…Œì´ë„ˆ í‘œì‹œ
        
        // ê°€ê²Œ ë°ì´í„° ë Œë”ë§
        container.innerHTML = stores.map(store => {
            // ìš”ì¼ ë° ìš´ì˜ì‹œê°„ ë°ì´í„° í•©ì¹˜ê¸°
            const days = ['ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼', 'ì¼ìš”ì¼'];
            const hours = [
                store.opening_hours_mon,
                store.opening_hours_tue,
                store.opening_hours_wed,
                store.opening_hours_thu,
                store.opening_hours_fri,
                store.opening_hours_sat,
                store.opening_hours_sun
            ];
    
            const openingHours = days.map((day, index) => 
            `<span>${day}: ${hours[index] || 'íœ´ë¬´'}</span>` // ê° ìš”ì¼ ë°ì´í„°ì— <span> ì¶”ê°€
        ).join('<br>');
    
            // HTML í…œí”Œë¦¿
            return `
            <div class="store-box" data-url="/store_details?id=${store.restaurant_id}">
                <img src="${store.restaurant_image}" alt="ê°€ê²Œ ì´ë¯¸ì§€" class="store-image">
                <div class="store-info">
                    <h2 class="store-name">${store.restaurant_name}</h2>
                    <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${store.category}</p>
                    <p><strong>ìº í¼ìŠ¤:</strong> ${store.campus}</p>
                    <p><strong>ì£¼ì†Œ:</strong> ${store.address}</p>
                    <p><strong>ìš´ì˜ì‹œê°„:</strong><br> ${openingHours}</p>
                </div>
                <input type="checkbox" class="store-toggle" data-store-id="${store.restaurant_id}">
            </div> 
            `;
        }).join(''); // map ê²°ê³¼ë¥¼ í•˜ë‚˜ì˜ HTML ë¬¸ìì—´ë¡œ ë³‘í•©
    }
    // ì—”í„° í‚¤ë¡œ ê²€ìƒ‰ ì‹¤í–‰
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            searchStores();
        }
    }
    
    // ê²€ìƒ‰ ê¸°ëŠ¥
    function searchStores() {
        const input = document.getElementById('search-input').value.trim().toLowerCase();
        const stores = document.getElementsByClassName('store-box');
        
        Array.from(stores).forEach(store => {
            const name = store.querySelector('.store-name').textContent.toLowerCase();
            const category = store.querySelector('.store-info p').textContent.toLowerCase();
            if (name.includes(input) || category.includes(input)) {
                store.style.display = ''; // ê²€ìƒ‰ì–´ì— ì¼ì¹˜í•˜ëŠ” ê²½ìš° í‘œì‹œ
            } else {
                store.style.display = 'none'; // ê²€ìƒ‰ì–´ì— ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° ìˆ¨ê¸°ê¸°
            }
        });
    }

    // ì°œì—ì„œ ì‚­ì œí•˜ê¸° ê¸°ëŠ¥
    async function removeFromFavorites() {
        const toggles = document.querySelectorAll('.store-toggle:checked');
        if (toggles.length === 0) {
            alert('ì‚­ì œí•  ê°€ê²Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
    
        const selectedIds = Array.from(toggles).map(toggle => {
            const id = parseInt(toggle.dataset.storeId, 10);
            return id;
        });        
    
        try {
            const response = await fetch('/api/remove-favorites', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ storeIds: selectedIds })
            });
    
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status); // ë””ë²„ê¹…
            if (response.ok) {
                toggles.forEach(toggle => {
                    toggle.closest('.store-box').remove();
                });
                alert('ì„ íƒí•œ ê°€ê²Œê°€ ì°œ ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                const errorData = await response.json();
                console.error('ì„œë²„ ì˜¤ë¥˜:', errorData); // ë””ë²„ê¹…
                alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${errorData.message}`);
            }
        } catch (error) {
            console.error('í†µì‹  ì˜¤ë¥˜:', error); // ë””ë²„ê¹…
            alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }    

    // ë¹„êµí•¨ìœ¼ë¡œ ê°€ê¸° ê¸°ëŠ¥
    async function goToCompare() {
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        const authResponse = await fetch('/auth/status');
        const authStatus = await authResponse.json();
    
        if (!authStatus.loggedIn) {
            alert('ë¹„êµí•¨ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
    
        const toggles = document.querySelectorAll('.store-toggle:checked');
        if (toggles.length > 2) {
            alert('ë¹„êµí•¨ì—ëŠ” ìµœëŒ€ 2ê°œë¥¼ ë‹´ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }
        if (toggles.length === 0) {
            alert('ë¹„êµí•¨ìœ¼ë¡œ ë³´ë‚¼ ê°€ê²Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
    
        const selectedStoreIds = Array.from(toggles).map(toggle => toggle.getAttribute('data-store-id'));
        try {
            const response = await fetch('/api/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ storeIds: selectedStoreIds, userId: authStatus.user.id }),
            });
    
            if (response.ok) {
                alert('ì„ íƒí•œ ê°€ê²Œê°€ ë¹„êµí•¨ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = `compare.html`;
            } else {
                const errorData = await response.json();
                alert(`ë¹„êµí•¨ì— ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${errorData.message}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('favorites-container');
    
        container.addEventListener('click', (event) => {
            const box = event.target.closest('.store-box');
            if (!box) return;
    
            // í´ë¦­í•œ ìš”ì†Œê°€ input íƒœê·¸ì¸ ê²½ìš° ì´ë²¤íŠ¸ë¥¼ ë¬´ì‹œ
            if (event.target.tagName === 'INPUT') return;
    
            const url = box.dataset.url;
            if (url) {
                console.log('ì´ë™í•  URL:', url); // ë””ë²„ê¹… ë¡œê·¸
                window.location.href = url;
            }
        });
    });
</script>
<script src="header_footer.js"></script> <!-- í—¤ë”ì™€ í‘¸í„° ë¡œë“œ -->

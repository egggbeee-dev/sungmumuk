<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <link rel="stylesheet" href="posts.css">
    <link rel="stylesheet" href="header_footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="header_footer.js" defer></script>
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="page-header">ììœ  ê²Œì‹œíŒ</div>

    <main>
        <section id="post-details">
            <div class="post-header">
                <span id="post-category"></span>
                <h1 id="post-title"></h1>
                <input type="text" id="edit-post-title" style="display: none;" />
            </div>
            <p id="post-author"></p>
            <p id="post-content"></p>
            <textarea id="edit-post-content" style="display: none;"></textarea>
            <img id="post-image" style="display: none;" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">
            <p id="post-date"></p>

            <div class="post-buttons">
                <a href="/free.html" class="back-btn">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                <div id="edit-delete-buttons" style="display: none;">
                    <button id="edit-post-btn">ìˆ˜ì •</button>
                    <button id="delete-post-btn">ì‚­ì œ</button>
                </div>
                <div id="edit-buttons" style="display: none;">
                    <button id="save-edit-btn">ì €ì¥</button>
                    <button id="cancel-edit-btn">ì·¨ì†Œ</button>
                </div>
            </div>
        </section>

        <section id="comments-section">
            <h3>ëŒ“ê¸€</h3>
            <div class="comment-input-container">
                <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button id="submit-comment-btn">ëŒ“ê¸€ ì‘ì„±</button>
            </div>
            <div id="comments-list"></div>
        </section>
    </main>

    <script>
        let currentUserId = null;
        let postAuthorId = null;
        let postId = null;

        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get("id");

            await checkAuthStatus();
            await loadPost();
            await loadComments();
            showEditDeleteButtons();
        });

        async function checkAuthStatus() {
            const response = await fetch("/auth/status");
            const authData = await response.json();
            if (authData.loggedIn) {
                currentUserId = authData.user.id;
            }
        }

        async function loadPost() {
            const response = await fetch(`/free/posts/${postId}`);
            const post = await response.json();

            document.getElementById("post-title").textContent = post.title;
            document.getElementById("post-author").textContent = `ì‘ì„±ì: ${post.author}`;
            document.getElementById("post-category").textContent = post.category;
            document.getElementById("post-content").innerHTML = post.content.replace(/\n/g, '<br>');
            document.getElementById("post-date").textContent = new Date(post.created_at).toLocaleString('ko-KR');

            if (post.image_url) {
                const postImage = document.getElementById("post-image");
                postImage.src = post.image_url;
                postImage.style.display = "block";
            }

            postAuthorId = post.user_id;
        }

        function showEditDeleteButtons() {
            if (currentUserId === postAuthorId) {
                document.getElementById("edit-delete-buttons").style.display = "flex";
            }
        }

        document.getElementById("edit-post-btn").onclick = () => startEditing();
        document.getElementById("save-edit-btn").onclick = () => saveEditedPost();
        document.getElementById("cancel-edit-btn").onclick = () => cancelEditing();
        document.getElementById("delete-post-btn").onclick = () => deletePost();
        document.getElementById("submit-comment-btn").onclick = () => submitComment();

        function startEditing() {
            document.getElementById("edit-post-title").value = document.getElementById("post-title").textContent;
            document.getElementById("edit-post-content").value = document.getElementById("post-content").innerText;

            document.getElementById("post-title").style.display = "none";
            document.getElementById("post-content").style.display = "none";
            document.getElementById("edit-post-title").style.display = "block";
            document.getElementById("edit-post-content").style.display = "block";
            document.getElementById("edit-delete-buttons").style.display = "none";
            document.getElementById("edit-buttons").style.display = "flex";
        }

        function cancelEditing() {
            document.getElementById("edit-post-title").style.display = "none";
            document.getElementById("edit-post-content").style.display = "none";
            document.getElementById("post-title").style.display = "block";
            document.getElementById("post-content").style.display = "block";
            document.getElementById("edit-buttons").style.display = "none";
            document.getElementById("edit-delete-buttons").style.display = "flex";
        }

        async function saveEditedPost() {
            const newTitle = document.getElementById("edit-post-title").value.trim();
            const newContent = document.getElementById("edit-post-content").value.trim();

            await fetch(`/free/posts/${postId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: newTitle, content: newContent })
            });
            window.location.reload();
        }

        async function deletePost() {
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await fetch(`/free/posts/${postId}`, { method: "DELETE" });
                window.location.href = "/free.html";
            }
        }

        // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (isLiked í¬í•¨ ë²„ì „)
// ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì¢‹ì•„ìš”ëŠ” ë¬´ì¡°ê±´ ğŸ‘ ê³ ì •)
async function loadComments() {
    try {
        const response = await fetch(`/free/posts/${postId}/comments`);
        const comments = await response.json();

        const commentsList = document.getElementById("comments-list");
        commentsList.innerHTML = "";

        if (comments.length === 0) {
            commentsList.innerHTML = "<p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        comments.forEach(comment => {
            const commentDiv = document.createElement("div");
            commentDiv.classList.add("comment");

            commentDiv.innerHTML = `
                <p><strong>${comment.author}</strong> - ${new Date(comment.created_at).toLocaleString('ko-KR')}</p>
                <p>${comment.content}</p>
                <div class="comment-actions">
                    <button class="like-comment-btn" onclick="likeComment(${comment.comment_id})">
                        ğŸ‘ ${comment.likes}
                    </button>
                    ${currentUserId === comment.user_id ? `<button class="delete-comment-btn" onclick="deleteComment(${comment.comment_id})">ğŸ—‘ï¸</button>` : ""}
                </div>
            `;

            commentsList.appendChild(commentDiv);
        });
    } catch (error) {
        console.error("ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:", error);
    }
}

// ëŒ“ê¸€ ì‘ì„±
async function submitComment() {
    const content = document.getElementById("comment-input").value.trim();
    if (!content) {
        alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }

    try {
        const response = await fetch(`/free/posts/${postId}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content })
        });

        if (response.ok) {
            document.getElementById("comment-input").value = ""; // ì‘ì„± í›„ ë¹„ìš°ê¸°
            await loadComments(); // ìµœì‹ í™”
        } else {
            alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (error) {
        console.error("ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:", error);
    }
}

// ëŒ“ê¸€ ì‚­ì œ
async function deleteComment(commentId) {
    if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const response = await fetch(`/free/comments/${commentId}`, { method: "DELETE" });

        if (response.ok) {
            await loadComments(); // ìµœì‹ í™”
        } else {
            alert("ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (error) {
        console.error("ëŒ“ê¸€ ì‚­ì œ ì˜¤ë¥˜:", error);
    }
}

// ì¢‹ì•„ìš” (ì—„ì§€ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë¬´ì¡°ê±´ ì¦ê°€)
async function likeComment(commentId) {
    try {
        const response = await fetch(`/free/comments/${commentId}/like`, { method: "POST" });

        if (response.ok) {
            await loadComments(); // ìµœì‹ í™”
        } else {
            alert("ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (error) {
        console.error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì˜¤ë¥˜:", error);
    }
}

    </script>
</body>
</html>

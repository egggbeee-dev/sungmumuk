<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <link rel="icon" href="ì„±ë­ë¨¹3.png" type="image/png" />
    <link rel="stylesheet" href="community_post.css" />
    <!-- ê²Œì‹œê¸€ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="header_footer.css" />
    <!-- í—¤ë”ì™€ í‘¸í„° ìŠ¤íƒ€ì¼ -->

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
      rel="stylesheet"
    />

    <script src="header_footer.js" defer></script>
    <!-- í—¤ë” ë° í‘¸í„° ë™ì  ë¡œë“œ -->
  </head>
  <body>
    <!-- í—¤ë” ë™ì  ë¡œë“œ -->
    <div id="header-placeholder"></div>

    <main>
      <section id="post-details" style="text-align: left; margin: 20px">
        <!-- ì¹´í…Œê³ ë¦¬ì™€ ì œëª©ì„ ê°™ì€ ì¤„ì— ë°°ì¹˜ -->
        <div
          style="
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-family: 'Black Han Sans', sans-serif;
            font-weight: bold;
          "
        >
          <span id="post-category" style="color: #555"></span>
          <h1 id="post-title" style="margin: 0; color: #6c63ff"></h1>
        </div>

        <!-- ì‘ì„±ì ì •ë³´ -->
        <p id="post-author" style="margin-top: 10px">ì‘ì„±ì:</p>

        <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
        <p id="post-content" style="margin-top: 10px"></p>

        <!-- ê²Œì‹œê¸€ ì´ë¯¸ì§€ -->
        <img
          id="post-image"
          style="display: none; width: 100%; margin-top: 10px"
          alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€"
        />

        <!-- ì‘ì„±ì¼ -->
        <p style="margin-top: 10px">ì‘ì„±ì¼: <span id="post-date"></span></p>
      </section>

      <a href="/free.html" class="back-btn">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

      <!-- ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
      <div id="edit-delete-buttons">
        <button id="edit-post-btn">ìˆ˜ì •</button>
        <button id="delete-post-btn">ì‚­ì œ</button>
      </div>

      <!-- ê²Œì‹œê¸€ ìˆ˜ì • í¼ -->
      <form id="edit-post-form" style="display: none">
        <textarea
          id="edit-post-content"
          rows="5"
          placeholder="ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”"
        ></textarea>
        <button type="button" id="save-edit-btn">ì €ì¥</button>
      </form>
    </main>

    <section id="comments-section">
      <h3>ëŒ“ê¸€</h3>
      <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
      <div class="comment-input-container">
        <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <button id="submit-comment-btn">ëŒ“ê¸€ ì‘ì„±</button>
      </div>
      <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
      <div id="comments-list"></div>
      <!-- "ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤." ë©”ì‹œì§€ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤. -->
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-logo">
        <img src="ì„±ë­ë¨¹2.png" alt="Logo" class="footer-logo-img" />
      </div>
      <div class="footer-info"></div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get("id");
        let currentUserId = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID
        let postAuthorId = null; // ê²Œì‹œê¸€ ì‘ì„±ì ID

        //await checkAuthStatus();
        await loadPost(postId);
        await loadComments(postId);

        // ê²Œì‹œê¸€ ë¡œë“œ í›„ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        if (currentUserId === postAuthorId) {
          document.getElementById("edit-delete-buttons").style.display =
            "block";
        }

        document
          .getElementById("edit-post-btn")
          .addEventListener("click", () => {
            document.getElementById("edit-post-form").style.display = "block";
            document.getElementById("edit-post-content").value =
              document.getElementById("post-content").textContent;
          });

        document
          .getElementById("save-edit-btn")
          .addEventListener("click", async () => {
            const newContent = document
              .getElementById("edit-post-content")
              .value.trim();
            if (!newContent) {
              alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }
            try {
              const response = await fetch(`/free/posts/${postId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: newContent }),
              });
              if (response.ok) {
                alert("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.reload();
              } else {
                alert("ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            } catch (error) {
              console.error("ìˆ˜ì • ì˜¤ë¥˜:", error);
            }
          });

        document
          .getElementById("delete-post-btn")
          .addEventListener("click", async () => {
            const confirmDelete = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!confirmDelete) return;

            try {
              const response = await fetch(`/free/posts/${postId}`, {
                method: "DELETE",
              });
              if (response.ok) {
                alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/free.html";
              } else {
                alert("ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            } catch (error) {
              console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
            }
          });

        document
          .getElementById("submit-comment-btn")
          .addEventListener("click", async () => {
            const content = document
              .getElementById("comment-input")
              .value.trim();
            if (!content) {
              alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }
            await submitComment(postId, content);
          });
      });

      /*async function checkAuthStatus() {
        try {
          const response = await fetch("/api/auth/status");
          const authData = await response.json();
          if (authData.loggedIn) {
            currentUserId = authData.userId;
            document.getElementById("comment-input").disabled = false;
            document.getElementById("submit-comment-btn").disabled = false;
          }
        } catch (error) {
          console.error("ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
        }
      }
        */

      async function loadPost(postId) {
        try {
          const response = await fetch(`/free/posts/${postId}`);
          const post = await response.json();

          console.log(post); // ì „ì²´ post ê°ì²´ í™•ì¸
          console.log(post.image_url); // ì´ë¯¸ì§€ URL í™•ì¸

          document.getElementById("post-title").textContent = post.title;
          document.getElementById(
            "post-author"
          ).textContent = `ì‘ì„±ì: ${post.author}`;
          document.getElementById("post-content").textContent = post.content;
          document.getElementById("post-date").textContent = new Date(
            post.created_at
          ).toLocaleString();
          document.getElementById("post-category").textContent = post.category;

          postAuthorId = post.user_id;

          if (post.image_url) {
            const postImage = document.getElementById("post-image");
            postImage.src = post.image_url; // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì´ë¯¸ì§€ ê²½ë¡œ
            postImage.style.display = "block";
          } else {
            console.warn("ì´ë¯¸ì§€ URLì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
        }
      }

      async function loadComments(postId) {
        try {
          const response = await fetch(`/free/posts/${postId}/comments`);
          const comments = await response.json();

          const commentsList = document.getElementById("comments-list");
          commentsList.innerHTML = "";

          if (comments.length === 0) {
            const emptyMessage = document.createElement("p");
            emptyMessage.textContent =
              "ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!";
            commentsList.appendChild(emptyMessage);
          } else {
            comments.forEach((comment) => {
              const commentDiv = document.createElement("div");
              commentDiv.classList.add("comment");
              commentDiv.id = `comment-${comment.comment_id}`;
              commentDiv.innerHTML = `
                            <p>${comment.content} - ì‘ì„±ì: ${
                comment.author || "ìµëª…"
              } (${new Date(comment.created_at).toLocaleString()})</p>
                            <button onclick="likeComment(${
                              comment.comment_id
                            })">ğŸ‘ <span class="like-count">${
                comment.likes || 0
              }</span></button>
                        `;
              commentsList.appendChild(commentDiv);
            });
          }
        } catch (error) {
          console.error("ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:", error);
        }
      }

      async function submitComment(postId, content) {
        try {
          const response = await fetch(`/free/posts/${postId}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content }),
          });
          if (response.ok) {
            alert("ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("comment-input").value = "";
            await loadComments(postId);
          } else {
            alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:", error);
        }
      }

      async function likeComment(commentId) {
        try {
          const response = await fetch(`/free/comments/${commentId}/like`, {
            method: "POST",
          });
          if (response.ok) {
            const likeCountElement = document.querySelector(
              `#comment-${commentId} .like-count`
            );
            if (likeCountElement) {
              const currentCount = parseInt(likeCountElement.textContent);
              likeCountElement.textContent = currentCount + 1;
            }
            alert("ì¢‹ì•„ìš”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else {
            alert("ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì˜¤ë¥˜:", error);
        }
      }
    </script>

    <!-- ë°˜ì‘í˜• -->
  </body>
</html>

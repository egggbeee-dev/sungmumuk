<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 상세</title>
    <link rel="stylesheet" href="posts.css">
    <link rel="stylesheet" href="header_footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="header_footer.js" defer></script>
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="page-header">자유 게시판</div>

    <main>
        <section id="post-details">
            <div class="post-header">
                <span id="post-category"></span>
                <h1 id="post-title"></h1>
                <input type="text" id="edit-post-title" style="display: none;" />
            </div>
            <p id="post-author"></p>
            <p id="post-content"></p>
            <textarea id="edit-post-content" style="display: none;"></textarea>
            <img id="post-image" style="display: none;" alt="게시글 이미지">
            <p id="post-date"></p>

            <div class="post-buttons">
                <a href="/free.html" class="back-btn">← 목록으로 돌아가기</a>
                <div id="edit-delete-buttons" style="display: none;">
                    <button id="edit-post-btn">수정</button>
                    <button id="delete-post-btn">삭제</button>
                </div>
                <div id="edit-buttons" style="display: none;">
                    <button id="save-edit-btn">저장</button>
                    <button id="cancel-edit-btn">취소</button>
                </div>
            </div>
        </section>

        <section id="comments-section">
            <h3>댓글</h3>
            <div class="comment-input-container">
                <textarea id="comment-input" placeholder="댓글을 입력하세요"></textarea>
                <button id="submit-comment-btn">댓글 작성</button>
            </div>
            <div id="comments-list"></div>
        </section>
    </main>

    <script>
        let currentUserId = null;
        let postAuthorId = null;
        let postId = null;

        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get("id");

            await checkAuthStatus();
            await loadPost();
            await loadComments();
            showEditDeleteButtons();
        });

        async function checkAuthStatus() {
            const response = await fetch("/auth/status");
            const authData = await response.json();
            if (authData.loggedIn) {
                currentUserId = authData.user.id;
            }
        }

        async function loadPost() {
            const response = await fetch(`/free/posts/${postId}`);
            const post = await response.json();

            document.getElementById("post-title").textContent = post.title;
            document.getElementById("post-author").textContent = `작성자: ${post.author}`;
            document.getElementById("post-category").textContent = post.category;
            document.getElementById("post-content").innerHTML = post.content.replace(/\n/g, '<br>');
            document.getElementById("post-date").textContent = new Date(post.created_at).toLocaleString('ko-KR');

            if (post.image_url) {
                const postImage = document.getElementById("post-image");
                postImage.src = post.image_url;
                postImage.style.display = "block";
            }

            postAuthorId = post.user_id;
        }

        function showEditDeleteButtons() {
            if (currentUserId === postAuthorId) {
                document.getElementById("edit-delete-buttons").style.display = "flex";
            }
        }

        document.getElementById("edit-post-btn").onclick = () => startEditing();
        document.getElementById("save-edit-btn").onclick = () => saveEditedPost();
        document.getElementById("cancel-edit-btn").onclick = () => cancelEditing();
        document.getElementById("delete-post-btn").onclick = () => deletePost();
        document.getElementById("submit-comment-btn").onclick = () => submitComment();

        function startEditing() {
            document.getElementById("edit-post-title").value = document.getElementById("post-title").textContent;
            document.getElementById("edit-post-content").value = document.getElementById("post-content").innerText;

            document.getElementById("post-title").style.display = "none";
            document.getElementById("post-content").style.display = "none";
            document.getElementById("edit-post-title").style.display = "block";
            document.getElementById("edit-post-content").style.display = "block";
            document.getElementById("edit-delete-buttons").style.display = "none";
            document.getElementById("edit-buttons").style.display = "flex";
        }

        function cancelEditing() {
            document.getElementById("edit-post-title").style.display = "none";
            document.getElementById("edit-post-content").style.display = "none";
            document.getElementById("post-title").style.display = "block";
            document.getElementById("post-content").style.display = "block";
            document.getElementById("edit-buttons").style.display = "none";
            document.getElementById("edit-delete-buttons").style.display = "flex";
        }

        async function saveEditedPost() {
            const newTitle = document.getElementById("edit-post-title").value.trim();
            const newContent = document.getElementById("edit-post-content").value.trim();

            await fetch(`/free/posts/${postId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: newTitle, content: newContent })
            });
            window.location.reload();
        }

        async function deletePost() {
            if (confirm("정말 삭제하시겠습니까?")) {
                await fetch(`/free/posts/${postId}`, { method: "DELETE" });
                window.location.href = "/free.html";
            }
        }

        // 댓글 불러오기 (isLiked 포함 버전)
// 댓글 목록 불러오기 (좋아요는 무조건 👍 고정)
async function loadComments() {
    try {
        const response = await fetch(`/free/posts/${postId}/comments`);
        const comments = await response.json();

        const commentsList = document.getElementById("comments-list");
        commentsList.innerHTML = "";

        if (comments.length === 0) {
            commentsList.innerHTML = "<p>댓글이 없습니다.</p>";
            return;
        }

        comments.forEach(comment => {
            const commentDiv = document.createElement("div");
            commentDiv.classList.add("comment");

            commentDiv.innerHTML = `
                <p><strong>${comment.author}</strong> - ${new Date(comment.created_at).toLocaleString('ko-KR')}</p>
                <p>${comment.content}</p>
                <div class="comment-actions">
                    <button class="like-comment-btn" onclick="likeComment(${comment.comment_id})">
                        👍 ${comment.likes}
                    </button>
                    ${currentUserId === comment.user_id ? `<button class="delete-comment-btn" onclick="deleteComment(${comment.comment_id})">🗑️</button>` : ""}
                </div>
            `;

            commentsList.appendChild(commentDiv);
        });
    } catch (error) {
        console.error("댓글 로드 오류:", error);
    }
}

// 댓글 작성
async function submitComment() {
    const content = document.getElementById("comment-input").value.trim();
    if (!content) {
        alert("댓글 내용을 입력하세요.");
        return;
    }

    try {
        const response = await fetch(`/free/posts/${postId}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content })
        });

        if (response.ok) {
            document.getElementById("comment-input").value = ""; // 작성 후 비우기
            await loadComments(); // 최신화
        } else {
            alert("댓글 작성에 실패했습니다.");
        }
    } catch (error) {
        console.error("댓글 작성 오류:", error);
    }
}

// 댓글 삭제
async function deleteComment(commentId) {
    if (!confirm("댓글을 삭제하시겠습니까?")) return;

    try {
        const response = await fetch(`/free/comments/${commentId}`, { method: "DELETE" });

        if (response.ok) {
            await loadComments(); // 최신화
        } else {
            alert("댓글 삭제에 실패했습니다.");
        }
    } catch (error) {
        console.error("댓글 삭제 오류:", error);
    }
}

// 좋아요 (엄지 버튼 누르면 무조건 증가)
async function likeComment(commentId) {
    try {
        const response = await fetch(`/free/comments/${commentId}/like`, { method: "POST" });

        if (response.ok) {
            await loadComments(); // 최신화
        } else {
            alert("좋아요 처리에 실패했습니다.");
        }
    } catch (error) {
        console.error("좋아요 처리 오류:", error);
    }
}

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurant Page</title>
    <link rel="icon" href="ì„±ë­ë¨¹3.png" type="image/png" />
    <link rel="stylesheet" href="store_details.css" />
    <!-- ê¸°ì¡´ CSS íŒŒì¼ì„ ë§í¬ -->
    <link rel="stylesheet" href="header_footer.css" />
    <!-- í—¤ë”ì™€ í‘¸í„° ìŠ¤íƒ€ì¼ -->
    <!-- Google Fonts -->
    <!-- ìŠ¤íƒ€ì¼ -->
    <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />
  </head>
  <body>
    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>
    <!-- Main Content -->
    <div class="container">
      <div class="header-actions">
        <button class="back-button" onclick="goBack()">&lt;</button>
        <button id="wishlist-button" class="wishlist-button">
            <span class="heart-icon">ğŸ¤</span><br>ì°œ
        </button>
        <button id="compare-button" class="compare-button">
          ğŸ”<br>ë¹„êµí•¨
      </button>
    </div>
    

      <!-- ê°€ê²Œ ì •ë³´ -->
      <header class="store-header">
        <h1 id="restaurant-name"></h1>
      </header>
      
      <!-- ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œì‡¼ ì„¹ì…˜ -->
      <div class="image-section">
        <button class="slide-button prev" onclick="changeSlide(-1)">&#10094;</button>
        <div class="store-image-container" id="restaurant-image-container">
            <!-- ì´ë¯¸ì§€ê°€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
        </div>
        <button class="slide-button next" onclick="changeSlide(1)">&#10095;</button>
    </div>

      <div class="info-section">
        <div class="info-box">
          <div class="info-label">ì£¼ì†Œ</div>
          <div class="info-content" id="restaurant-address"></div>
        </div>
        <div class="info-box">
          <div class="info-label">ìº í¼ìŠ¤ ìœ„ì¹˜</div>
          <div class="info-content" id="restaurant-campus"></div>
        </div>
        <div class="info-box">
          <div class="info-label">í‰ì </div>
          <div class="info-content" id="restaurant-rating"></div>
        </div>
        <div class="info-box">
          <div class="info-label">ì¹´í…Œê³ ë¦¬</div>
          <div class="info-content" id="restaurant-category"></div>
        </div>
        <div class="info-box">
          <div class="info-label">í‰ê·  ê°€ê²©(1ì¸)</div>
          <div class="info-content" id="restaurant-price"></div>
        </div>
        <div class="info-box">
          <div class="info-label">ê¸°íƒ€</div>
          <div class="info-content" id="restaurant-features"></div>
        </div>
        <div class="info-box">
          <div class="info-label">ì œíœ´</div>
          <div class="info-content" id="restaurant-partnership"></div>
        </div>
        <div class="info-box">
          <div class="info-label">ì—°ë½ì²˜</div>
          <div class="info-content" id="restaurant-contact"></div>
        </div>
        <div class="info-box">
          <div class="info-label">ìš´ì˜ì‹œê°„</div>
          <div class="info-content" id="restaurant-hours">
          </div>
        </div>
      </div>
    </div>

    <!-- ë¦¬ë·° ì„¹ì…˜ -->
    <div class="review-section">
      <div class="review-header">
        <h2>ë¦¬ë·°</h2>
        <button class="review-register-button" onclick="redirectToReviewPage()">
          ë¦¬ë·° ì‘ì„±í•˜ê¸°
        </button>
      </div>

      <!-- ë¦¬ë·° ëª©ë¡ -->
      <div class="review-list" id="review-list"></div>

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      <div class="pagination">
        <button id="prevPageButton" onclick="changePage(-1)" disabled>
          ì´ì „
        </button>
        <span id="currentPageLabel">1</span>
        <button id="nextPageButton" onclick="changePage(1)">ë‹¤ìŒ</button>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const storedID = urlParams.get("id");

      let currentPage = 1;
      const reviewsPerPage = 10;
      let imageUrls = [];  // imageUrls ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
      let currentSlideIndex = 0;  // í˜„ì¬ ìŠ¬ë¼ì´ë“œ ì¸ë±ìŠ¤

      async function displayRestaurantDetails() {
        try {
          const storeId = new URLSearchParams(window.location.search).get("id");
          const response = await fetch(`/store_details/data?id=${storeId}`);
          const restaurant = await response.json();
          imageUrls = restaurant.images || []; // ì´ë¯¸ì§€ URL ë°°ì—´ ì„¤ì •

    updateSlideShow(); // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
          document.querySelector("#restaurant-name").textContent =
            restaurant.restaurant_name;
          document.querySelector("#restaurant-address").textContent =
            restaurant.address;
          document.querySelector("#restaurant-campus").textContent =
            restaurant.campus;
          document.querySelector(
            "#restaurant-rating"
          ).textContent = `${restaurant.average_rating} / 5.00`;
          document.querySelector("#restaurant-category").textContent =
            restaurant.category;
            document.querySelector("#restaurant-price").textContent =
           restaurant.average_price;
          document.querySelector("#restaurant-features").innerHTML = `
                    í˜¼ë°¥ : ${restaurant.solo_meal ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"} <br>
                    ë‹¨ì²´ : ${restaurant.group_meal ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"} <br>
                    ì¹´ê³µ : ${restaurant.cafe_study ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"} <br>
                    ê°€ì„±ë¹„ : ${restaurant.good_price ? "ì¢‹ìŒ" : "ë³´í†µ"} <br>
                    ë¶„ìœ„ê¸° : ${restaurant.good_mood ? "ì¢‹ìŒ" : "ë³´í†µ"} <br>
                    ì‹¬ì•¼ : ${restaurant.late_night ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"} <br>
                `;

          document.querySelector("#restaurant-contact").textContent =
            restaurant.contact_number;
          document.querySelector("#restaurant-partnership").textContent =
            restaurant.partnership;
          const hoursHTML = `
                    <div>ì›”ìš”ì¼: ${restaurant.opening_hours_mon || "íœ´ë¬´"}</div>
                    <div>í™”ìš”ì¼: ${restaurant.opening_hours_tue || "íœ´ë¬´"}</div>
                    <div>ìˆ˜ìš”ì¼: ${restaurant.opening_hours_wed || "íœ´ë¬´"}</div>
                    <div>ëª©ìš”ì¼: ${restaurant.opening_hours_thu || "íœ´ë¬´"}</div>
                    <div>ê¸ˆìš”ì¼: ${restaurant.opening_hours_fri || "íœ´ë¬´"}</div>
                    <div>í† ìš”ì¼: ${restaurant.opening_hours_sat || "íœ´ë¬´"}</div>
                    <div>ì¼ìš”ì¼: ${restaurant.opening_hours_sun || "íœ´ë¬´"}</div>
                `;
          document.querySelector("#restaurant-hours").innerHTML = hoursHTML;
        } catch (error) {
          console.error("ê°€ê²Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }
      // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ì—…ë°ì´íŠ¸
      function updateSlideShow() {
  const container = document.getElementById("restaurant-image-container");
  container.innerHTML = "";  // ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±°
  currentSlideIndex = 0;  // ìŠ¬ë¼ì´ë“œ ì¸ë±ìŠ¤ ì´ˆê¸°í™”

  imageUrls.forEach((url, index) => {
    const imgElement = document.createElement("img");
    imgElement.src = url;
    imgElement.className = "store-image";
    imgElement.style.display = index === 0 ? "block" : "none"; // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë§Œ ë³´ì´ê²Œ ì„¤ì •
    container.appendChild(imgElement);
  });

  updateButtonVisibility();  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
}

function updateButtonVisibility() {
  document.querySelector(".prev").disabled = currentSlideIndex === 0;
  document.querySelector(".next").disabled = currentSlideIndex === imageUrls.length - 1;
}

// ìŠ¬ë¼ì´ë“œ ì´ë™ í•¨ìˆ˜
function changeSlide(direction) {
  const slides = document.querySelectorAll(".store-image");
  if (slides.length === 0) return;

  slides[currentSlideIndex].style.display = "none";
  currentSlideIndex += direction;

  // ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë„˜ì–´ê°€ì§€ ì•Šê²Œ ì œí•œ
  if (currentSlideIndex < 0) currentSlideIndex = 0;
  if (currentSlideIndex >= slides.length) currentSlideIndex = slides.length - 1;

  slides[currentSlideIndex].style.display = "block";
  updateButtonVisibility(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
}
document.addEventListener("DOMContentLoaded", displayRestaurantDetails);  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ì‹œì‘


      async function loadReviews() {
            try {
                const response = await fetch(`/store_details/reviews?id=${storedID}`);
                const reviews = await response.json();

                if (reviews.length === 0) {
                    document.getElementById('review-list').innerHTML = "<p>ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                    document.getElementById('prevPageButton').disabled = true;
                    document.getElementById('nextPageButton').disabled = true;
                    return;
                }

                renderReviews(reviews);
            } catch (error) {
                console.error('ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                document.getElementById('review-list').innerHTML = "<p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
            }
        }

              function generateStars(rating) {
        const maxStars = 5; // ìµœëŒ€ ë³„ ê°œìˆ˜
        let stars = "";

        for (let i = 1; i <= maxStars; i++) {
          stars += `<span class="star ${i <= rating ? "selected" : ""}">â˜…</span>`;
        }

        return stars;
      }


      function renderReviews(reviews) {
        const reviewList = document.getElementById("review-list");
        reviewList.innerHTML = "";

        const startIndex = (currentPage - 1) * reviewsPerPage;
        const endIndex = Math.min(startIndex + reviewsPerPage, reviews.length);
        const currentReviews = reviews.slice(startIndex, endIndex);

        currentReviews.forEach((review) => {
          const reviewItem = document.createElement("div");
          reviewItem.className = "review-item";
          reviewItem.setAttribute("data-id", review.review_id); // ë¦¬ë·° IDë¥¼ ì„¤ì •

          const reviewPhotoHTML = `
    <div class="review-photo">
        <img src="${
          review.review_photo
            ? `/review/${review.review_photo}`
            : "ì„±ë­ë¨¹1.png"
        }" 
             alt="ë¦¬ë·° ì´ë¯¸ì§€" 
             style="max-width: 100%; height: auto; max-height: 200px; object-fit: cover;">
    </div>`;

          reviewItem.innerHTML = `
            ${reviewPhotoHTML}
            <div class="review-text">
                <strong>ë§›: ${generateStars(review.taste_rating)}</strong><br>
                <strong>ì ‘ê·¼ì„±: ${generateStars(
                  review.access_rating
                )}</strong><br>
                <strong>ì¬ë°©ë¬¸: ${generateStars(
                  review.revisit_rating
                )}</strong><br>
                <div class="review-snippet">
                     ${review.review_text}
                </div>
                <span style="color: gray; font-size: 0.8em;"> ${
                  review.reviewer || "ìµëª…"
                } </span><br>
              <span style="color: gray; font-size: 0.8em;">ì‘ì„±ì¼: ${formatDate(review.created_at)}</span>

            </div>
        `;

          // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          reviewItem.addEventListener("click", () => {
            handleReviewClick(review.review_id);
          });

          reviewList.appendChild(reviewItem);
        });

        document.getElementById("prevPageButton").disabled = currentPage === 1;
        document.getElementById("nextPageButton").disabled =
          endIndex >= reviews.length;
        document.getElementById("currentPageLabel").textContent = currentPage;
      }

      function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0"); // 0-based indexì´ë¯€ë¡œ +1
    const day = String(date.getDate()).padStart(2, "0");
    const hours = String(date.getHours()).padStart(2, "0");
    const minutes = String(date.getMinutes()).padStart(2, "0");

    return `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}ì‹œ : ${minutes}ë¶„`;
}

      function changePage(direction) {
        currentPage += direction;
        loadReviews();
      }

      document.addEventListener("DOMContentLoaded", () => {
        displayRestaurantDetails();
        loadReviews();
      });

      function redirectToReviewPage() {
        const restaurantName =
          document.getElementById("restaurant-name").textContent;
        if (storedID && restaurantName) {
          window.location.href = `/reviews_register.html?storeName=${encodeURIComponent(
            restaurantName
          )}&id=${storedID}`;
        } else {
          alert("ê°€ê²Œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      function handleReviewClick(reviewId) {
        // ë¦¬ë·° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `/store_review.html?id=${reviewId}`;
      }
      console.log('imageUrls:', imageUrls);  // imageUrls ë°°ì—´ ë‚´ìš© ì¶œë ¥
      function goBack() {
    window.history.back();
}
    </script>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <script src="header_footer.js"></script>
    <script src="store_details.js"></script>


    <!-- ë°˜ì‘í˜• -->
  </body>
</html>
